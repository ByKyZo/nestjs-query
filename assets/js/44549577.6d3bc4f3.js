(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{107:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return a})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return d}));var r=n(3),i=(n(0),n(218));const o={title:"QueryService"},a={unversionedId:"concepts/services",id:"concepts/services",isDocsHomePage:!1,title:"QueryService",description:"The core package defines a QueryService which is used to query and modify records.",source:"@site/docs/concepts/services.md",slug:"/concepts/services",permalink:"/nestjs-query/docs/concepts/services",editUrl:"https://github.com/doug-martin/nestjs-query/edit/master/documentation/docs/concepts/services.md",version:"current",sidebar:"docs",previous:{title:"Queries",permalink:"/nestjs-query/docs/concepts/queries"},next:{title:"Assemblers",permalink:"/nestjs-query/docs/concepts/advanced/assemblers"}},l=[{value:"Methods",id:"methods",children:[{value:"<code>query</code>",id:"query",children:[]},{value:"<code>findById</code>",id:"findbyid",children:[]},{value:"<code>getById</code>",id:"getbyid",children:[]},{value:"<code>createMany</code>",id:"createmany",children:[]},{value:"<code>createOne</code>",id:"createone",children:[]},{value:"<code>updateMany</code>",id:"updatemany",children:[]},{value:"<code>updateOne</code>",id:"updateone",children:[]},{value:"<code>deleteMany</code>",id:"deletemany",children:[]},{value:"<code>deleteOne</code>",id:"deleteone",children:[]},{value:"<code>aggregate</code>",id:"aggregate",children:[]},{value:"<code>count</code>",id:"count",children:[]},{value:"<code>queryRelations</code>",id:"queryrelations",children:[]},{value:"<code>aggregateRelations</code>",id:"aggregaterelations",children:[]},{value:"<code>countRelations</code>",id:"countrelations",children:[]},{value:"<code>findRelation</code>",id:"findrelation",children:[]},{value:"<code>addRelations</code>",id:"addrelations",children:[]},{value:"<code>setRelation</code>",id:"setrelation",children:[]},{value:"<code>removeRelations</code>",id:"removerelations",children:[]},{value:"<code>removeRelation</code>",id:"removerelation",children:[]}]},{value:"Service Helpers",id:"service-helpers",children:[{value:"RelationQueryService",id:"relationqueryservice",children:[]},{value:"ProxyQueryService",id:"proxyqueryservice",children:[]},{value:"NoOpQueryService",id:"noopqueryservice",children:[]}]}],s={toc:l};function d({components:e,...t}){return Object(i.b)("wrapper",Object(r.a)({},s,t,{components:e,mdxType:"MDXLayout"}),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"core")," package defines a ",Object(i.b)("inlineCode",{parentName:"p"},"QueryService")," which is used to query and modify records."),Object(i.b)("h2",{id:"methods"},"Methods"),Object(i.b)("p",null,"The following methods are defined on the ",Object(i.b)("inlineCode",{parentName:"p"},"QueryService")),Object(i.b)("h3",{id:"query"},Object(i.b)("inlineCode",{parentName:"h3"},"query")),Object(i.b)("p",null,"Query for multiple records, with a filter, paging and sorting."),Object(i.b)("h4",{id:"arguments"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"query: Query<DTO>")," - The query to filter, page, and sort results.")),Object(i.b)("h4",{id:"returns"},"Returns"),Object(i.b)("p",null,"An array of DTOs "),Object(i.b)("h3",{id:"findbyid"},Object(i.b)("inlineCode",{parentName:"h3"},"findById")),Object(i.b)("p",null,"Find a record by its id."),Object(i.b)("h4",{id:"arguments-1"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"id: string | number")," - The id of the record to find")),Object(i.b)("h4",{id:"returns-1"},"Returns"),Object(i.b)("p",null,"The DTO or undefined"),Object(i.b)("h3",{id:"getbyid"},Object(i.b)("inlineCode",{parentName:"h3"},"getById")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"get a record by its id or return a rejected promise with a NotFound error.")),Object(i.b)("h4",{id:"arguments-2"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"id: string | number")," - The id of the record to find")),Object(i.b)("h4",{id:"returns-2"},"Returns"),Object(i.b)("p",null,"The DTO or a NotFoundException."),Object(i.b)("h3",{id:"createmany"},Object(i.b)("inlineCode",{parentName:"h3"},"createMany")),Object(i.b)("p",null,"Create multiple records."),Object(i.b)("h4",{id:"arguments-3"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"items: DeepPartial<DTO>[]")," - An array of partial DTOs to persist")),Object(i.b)("h4",{id:"returns-3"},"Returns"),Object(i.b)("p",null,"The saved DTOs."),Object(i.b)("h3",{id:"createone"},Object(i.b)("inlineCode",{parentName:"h3"},"createOne")),Object(i.b)("p",null,"Create a single DTO."),Object(i.b)("h4",{id:"arguments-4"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"item: DeepPartial<DTO>")," - A partial of the DTO to persist")),Object(i.b)("h4",{id:"returns-4"},"Returns"),Object(i.b)("p",null,"The saved DTO"),Object(i.b)("h3",{id:"updatemany"},Object(i.b)("inlineCode",{parentName:"h3"},"updateMany")),Object(i.b)("p",null,"Update multiple records based on a filter."),Object(i.b)("h4",{id:"arguments-5"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"update: DeepPartial<DTO>")," - The update to apply"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"filter: Filter<DTO>")," - A ",Object(i.b)("inlineCode",{parentName:"li"},"Filter")," used to find the records to update")),Object(i.b)("h4",{id:"returns-5"},"Returns"),Object(i.b)("p",null,"An object with the ",Object(i.b)("inlineCode",{parentName:"p"},"updatedCount")),Object(i.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(i.b)("div",{parentName:"div",className:"admonition-heading"},Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",{parentName:"h5",className:"admonition-icon"},Object(i.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},Object(i.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),Object(i.b)("div",{parentName:"div",className:"admonition-content"},Object(i.b)("p",{parentName:"div"},"UpdatedCount may be 0 if the database does not return the number of rows updated."))),Object(i.b)("h3",{id:"updateone"},Object(i.b)("inlineCode",{parentName:"h3"},"updateOne")),Object(i.b)("p",null,"Update a single record."),Object(i.b)("h4",{id:"arguments-6"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"id: string | number")," - The id of the record to update"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"update: DeepPartial<DTO>")," - The update to apply")),Object(i.b)("h4",{id:"returns-6"},"Returns"),Object(i.b)("p",null,"The updated DTO"),Object(i.b)("h3",{id:"deletemany"},Object(i.b)("inlineCode",{parentName:"h3"},"deleteMany")),Object(i.b)("p",null,"Delete multiple records."),Object(i.b)("h4",{id:"arguments-7"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"filter: Filter<DTO>")," - The filter to find the records to delete.")),Object(i.b)("h4",{id:"returns-7"},"Returns"),Object(i.b)("p",null,"An object with a ",Object(i.b)("inlineCode",{parentName:"p"},"deletedCount")," field. "),Object(i.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(i.b)("div",{parentName:"div",className:"admonition-heading"},Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",{parentName:"h5",className:"admonition-icon"},Object(i.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},Object(i.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),Object(i.b)("div",{parentName:"div",className:"admonition-content"},Object(i.b)("p",{parentName:"div"},Object(i.b)("inlineCode",{parentName:"p"},"deletedCount")," may be 0 if the database does not return the number of rows deleted."))),Object(i.b)("p",null,":::"),Object(i.b)("h3",{id:"deleteone"},Object(i.b)("inlineCode",{parentName:"h3"},"deleteOne")),Object(i.b)("p",null,"Delete a single record."),Object(i.b)("h4",{id:"arguments-8"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"id: number | string"))),Object(i.b)("h4",{id:"returns-8"},"Returns"),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"Promise<DTO>")),Object(i.b)("h3",{id:"aggregate"},Object(i.b)("inlineCode",{parentName:"h3"},"aggregate")),Object(i.b)("p",null,"Performs an aggregate query, supported aggregate functions are ",Object(i.b)("inlineCode",{parentName:"p"},"count"),", ",Object(i.b)("inlineCode",{parentName:"p"},"sum"),", ",Object(i.b)("inlineCode",{parentName:"p"},"avg"),", ",Object(i.b)("inlineCode",{parentName:"p"},"min"),", and ",Object(i.b)("inlineCode",{parentName:"p"},"max")),Object(i.b)("h4",{id:"arguments-9"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"filter: Filter<DTO>")," - Additional filter to apply"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"aggregate: AggregateQuery<DTO>")," - The aggregate query")),Object(i.b)("p",null,"Example ",Object(i.b)("inlineCode",{parentName:"p"},"AggregateQuery")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-ts"},"{\n  count: ['id'],\n  sum: ['priority'],\n  avg: ['priority'],\n  min: ['id', 'title'],\n  max: ['id', 'title']\n}\n")),Object(i.b)("h4",{id:"returns-9"},"Returns"),Object(i.b)("p",null,"An aggregate response."),Object(i.b)("p",null,"Example ",Object(i.b)("inlineCode",{parentName:"p"},"AggregateResponse")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-ts"},"{\n  count: { id: 5 },\n  sum: { id: 10 },\n  avg: { id: 2.5 },\n  min: {id: 1, title: 'A Title'},\n  max: {id: 4, title: 'Z Title'}\n}\n")),Object(i.b)("h3",{id:"count"},Object(i.b)("inlineCode",{parentName:"h3"},"count")),Object(i.b)("p",null,"Count the number of records that match the ",Object(i.b)("inlineCode",{parentName:"p"},"filter")),Object(i.b)("h4",{id:"arguments-10"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"filter: Filter<DTO>")," - The filter a count records by")),Object(i.b)("h4",{id:"returns-10"},"Returns"),Object(i.b)("p",null,"A count of records that match the ",Object(i.b)("inlineCode",{parentName:"p"},"filter")),Object(i.b)("h3",{id:"queryrelations"},Object(i.b)("inlineCode",{parentName:"h3"},"queryRelations")),Object(i.b)("p",null,"Query for relations "),Object(i.b)("h4",{id:"arguments-11"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"RelationClass: Class<Relation>")," - The ",Object(i.b)("inlineCode",{parentName:"li"},"Class")," type of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationName: string")," - The name of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"dto: DTO | DTO[]")," - The dto(s) to find the relations for."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"query: Query<Relation>")," - Additional query to use when querying for relations.")),Object(i.b)("h4",{id:"returns-11"},"Returns"),Object(i.b)("p",null,"If querying for relations for a single ",Object(i.b)("inlineCode",{parentName:"p"},"DTO")," an array of relations will be returned.\nIf querying for relations for multiple ",Object(i.b)("inlineCode",{parentName:"p"},"DTOs")," a map where the key is the ",Object(i.b)("inlineCode",{parentName:"p"},"DTO")," and the value is the relations for the ",Object(i.b)("inlineCode",{parentName:"p"},"DTO"),"."),Object(i.b)("h3",{id:"aggregaterelations"},Object(i.b)("inlineCode",{parentName:"h3"},"aggregateRelations")),Object(i.b)("p",null,"Performs an aggregate query for the relations of a ",Object(i.b)("inlineCode",{parentName:"p"},"DTO"),"."),Object(i.b)("h4",{id:"arguments-12"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"RelationClass: Class<Relation>")," - The ",Object(i.b)("inlineCode",{parentName:"li"},"Class")," type of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationName: string")," - The name of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"dto: DTO | DTO[]")," - The dto(s) to aggregate the relations for."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"filter: Filter<Relation>")," - A ",Object(i.b)("inlineCode",{parentName:"li"},"filter")," to apply when aggregating relations"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"aggregate: AggregateQuery<Relation>")," - The ",Object(i.b)("inlineCode",{parentName:"li"},"aggregateQuery")," for the relations")),Object(i.b)("h4",{id:"returns-12"},"Returns"),Object(i.b)("p",null,"If aggregating relations for a single ",Object(i.b)("inlineCode",{parentName:"p"},"DTO")," an ",Object(i.b)("inlineCode",{parentName:"p"},"AggregateResponse")," for the dtos relations will be returned\nIf aggregating relations for multiple ",Object(i.b)("inlineCode",{parentName:"p"},"DTOs")," a map where the key is the ",Object(i.b)("inlineCode",{parentName:"p"},"DTO")," and the value is the ",Object(i.b)("inlineCode",{parentName:"p"},"AggregateResponse")," for the dtos relations."),Object(i.b)("h3",{id:"countrelations"},Object(i.b)("inlineCode",{parentName:"h3"},"countRelations")),Object(i.b)("p",null,"Counts the number of relations."),Object(i.b)("h4",{id:"arguments-13"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"RelationClass: Class<Relation>")," - The ",Object(i.b)("inlineCode",{parentName:"li"},"Class")," type of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationName: string")," - The name of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"dto: DTO | DTO[]")," - The dto(s) to count the relations for."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"filter: Filter<Relation>"),"- A ",Object(i.b)("inlineCode",{parentName:"li"},"filter")," to apply when counting relations")),Object(i.b)("h4",{id:"returns-13"},"Returns"),Object(i.b)("p",null,"If counting relations for a single ",Object(i.b)("inlineCode",{parentName:"p"},"DTO")," the relation count will be returned\nIf counting relations for multiple ",Object(i.b)("inlineCode",{parentName:"p"},"DTOs")," a map where the key is the ",Object(i.b)("inlineCode",{parentName:"p"},"DTO")," and the value is relation count for the dtos relations."),Object(i.b)("h3",{id:"findrelation"},Object(i.b)("inlineCode",{parentName:"h3"},"findRelation")),Object(i.b)("p",null,"Find a single relation for the ",Object(i.b)("inlineCode",{parentName:"p"},"DTO"),"(s)."),Object(i.b)("h4",{id:"arguments-14"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"RelationClass: Class<Relation>")," - The ",Object(i.b)("inlineCode",{parentName:"li"},"Class")," type of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationName: string")," - The name of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"dto: DTO | DTO[]")," - The dto(s) to find the relation for."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"opts?: FindRelationOptions<Relation>")," - Additional options to find a relation by.")),Object(i.b)("h4",{id:"returns-14"},"Returns"),Object(i.b)("p",null,"If finding a relation for a single ",Object(i.b)("inlineCode",{parentName:"p"},"DTO")," the relation or undefineding returned\nIf finding a relation for multiple ",Object(i.b)("inlineCode",{parentName:"p"},"DTOs")," a map where the key is the ",Object(i.b)("inlineCode",{parentName:"p"},"DTO")," and the value is the relation or undefined."),Object(i.b)("h3",{id:"addrelations"},Object(i.b)("inlineCode",{parentName:"h3"},"addRelations")),Object(i.b)("p",null,"Adds relations to a ",Object(i.b)("inlineCode",{parentName:"p"},"DTO")),Object(i.b)("h4",{id:"arguments-15"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationName: string")," - The name of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"id: string | number")," - The id of the DTO to add the relations to"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationIds: (string | number)[]")," - The ids of the relations to add"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"opts?: ModifyRelationOptions<DTO, Relation>")," - Additional options apply when adding relations")),Object(i.b)("h4",{id:"returns-15"},"Returns"),Object(i.b)("p",null,"The DTO the relations were added to."),Object(i.b)("h3",{id:"setrelation"},Object(i.b)("inlineCode",{parentName:"h3"},"setRelation")),Object(i.b)("p",null,"Set a relation on a DTO"),Object(i.b)("h4",{id:"arguments-16"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationName: string")," - The name of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"id: string | number")," - The id of the DTO to add the relations to"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationId: string | number")," - The id of the relation to set on the DTO"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"opts?: ModifyRelationOptions<DTO, Relation>")," - Additional options apply when setting the relation")),Object(i.b)("h4",{id:"returns-16"},"Returns"),Object(i.b)("p",null,"The DTO the relation was set on."),Object(i.b)("h3",{id:"removerelations"},Object(i.b)("inlineCode",{parentName:"h3"},"removeRelations")),Object(i.b)("p",null,"Removes multiple relations from a DTO"),Object(i.b)("h4",{id:"arguments-17"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationName: string")," - The name of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"id: string | number")," - The id of the DTO to remove the relations from."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationIds: (string | number)[]")," - The ids of the relations to remove"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"opts?: ModifyRelationOptions<DTO, Relation>")," - Additional options to apply when removing relations")),Object(i.b)("h4",{id:"returns-17"},"Returns"),Object(i.b)("p",null,"The DTO the relations were removed from"),Object(i.b)("h3",{id:"removerelation"},Object(i.b)("inlineCode",{parentName:"h3"},"removeRelation")),Object(i.b)("p",null,"Remove a relation from a DTO"),Object(i.b)("h4",{id:"arguments-18"},"Arguments"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationName: string")," - The name of the relation"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"id: string | number")," - The id of the DTO to remove the relation from."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"relationId: string | number")," - The id of the relation to remove"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"opts?: ModifyRelationOptions<DTO, Relation>")," - Additional options to apply when removing the relation.")),Object(i.b)("h4",{id:"returns-18"},"Returns"),Object(i.b)("p",null,"The DTO the relation was removed from."),Object(i.b)("h2",{id:"service-helpers"},"Service Helpers"),Object(i.b)("p",null,"You can create your own service to use with the ",Object(i.b)("inlineCode",{parentName:"p"},"CRUDResolver")," as long as it implements the ",Object(i.b)("inlineCode",{parentName:"p"},"QueryService")," interface."),Object(i.b)("p",null,"There are a number of persistence ",Object(i.b)("inlineCode",{parentName:"p"},"QueryServices")," that are provided out of the box."),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"/nestjs-query/docs/persistence/typeorm/getting-started"},"@nestjs-query/query-typeorm")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"/nestjs-query/docs/persistence/sequelize/getting-started"},"@nestjs-query/query-sequelize")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"/nestjs-query/docs/persistence/mongoose/getting-started"},"@nestjs-query/query-mongoose"))),Object(i.b)("p",null,"In addition to the persistence ",Object(i.b)("inlineCode",{parentName:"p"},"QueryServices")," ",Object(i.b)("inlineCode",{parentName:"p"},"@nestjs-query/core")," provides a few helper services that can be used for more complex use cases."),Object(i.b)("p",null,"When designing the base services we have chosen composition over inheritance. This approach lends itself well to modeling complex services without repeating yourself."),Object(i.b)("h3",{id:"relationqueryservice"},"RelationQueryService"),Object(i.b)("p",null,"The RelationQueryService was originally designed for ",Object(i.b)("a",{parentName:"p",href:"/nestjs-query/docs/graphql/federation"},"federation"),", but has proven itself useful in representing virtual relations. A virtual relation(s) is anything that can be queried through a query service."),Object(i.b)("p",null,"To create additional relations through a RelationQueryService you need to provide the following"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"A ",Object(i.b)("inlineCode",{parentName:"li"},"QueryService")," that can be used to fetch the relation"),Object(i.b)("li",{parentName:"ul"},"A ",Object(i.b)("inlineCode",{parentName:"li"},"query")," function that accepts the parent DTO to fetch the relation for and returns a ",Object(i.b)("inlineCode",{parentName:"li"},"Query")," to fetch the relations.")),Object(i.b)("div",{className:"admonition admonition-info alert alert--info"},Object(i.b)("div",{parentName:"div",className:"admonition-heading"},Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",{parentName:"h5",className:"admonition-icon"},Object(i.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},Object(i.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),Object(i.b)("div",{parentName:"div",className:"admonition-content"},Object(i.b)("p",{parentName:"div"},"Relations defined using the ",Object(i.b)("inlineCode",{parentName:"p"},"RelationQueryService")," are readonly!"))),Object(i.b)("p",null,"When a relation query method is called it will:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"First check if the relation is a virtual relation, if ",Object(i.b)("inlineCode",{parentName:"li"},"true")," it will invoke the ",Object(i.b)("inlineCode",{parentName:"li"},"query")," option to generate a query that will be\npassed to the ",Object(i.b)("inlineCode",{parentName:"li"},"queryService")," to fetch the relations."),Object(i.b)("li",{parentName:"ul"},"If the relation is not a ",Object(i.b)("inlineCode",{parentName:"li"},"virtual")," relation it will proxy to the original query service to query for the relation.")),Object(i.b)("p",null,"For example, we could wrap the ",Object(i.b)("inlineCode",{parentName:"p"},"TodoItem")," query service and add a ",Object(i.b)("inlineCode",{parentName:"p"},"completedSubTasks")," relation."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-ts",metastring:'title="todo-item/todo-item.service.ts"',title:'"todo-item/todo-item.service.ts"'},"import { InjectQueryService, QueryService, RelationQueryService } from '@nestjs-query/core';\nimport { TodoItemEntity } from './todo-item.entity';\nimport { SubTaskEntity } from '../sub-task/sub-task.entity';\n\nexport class TodoItemService extends RelationQueryService<TodoItemEntity> {\n  constructor(\n    @InjectQueryService(TodoItemEntity) queryService: QueryService<TodoItemEntity>,\n    @InjectQueryService(SubTaskEntity) subTaskQueryService: QueryService<SubTaskEntity>,\n  ) {\n    // provide the original query service so all relations defined in the ORM work\n    super(queryService, {\n      // specify the virtual relations\n      completedSubTasks: {\n        // provide the service that will be used to query the relation\n        service: subTaskQueryService,\n        // the query method accepts a todoItem that can be used to filter the relations\n        query(todoItem) {\n          // filter for all relations that belong to the todoItem and are completed\n          return { filter: { todoItemId: { eq: todoItem.id }, completed: { is: true } } };\n        },\n      },\n    });\n  }\n}\n")),Object(i.b)("p",null,"Once the ",Object(i.b)("inlineCode",{parentName:"p"},"relation")," is defined in the query service we can add it to our ",Object(i.b)("inlineCode",{parentName:"p"},"DTO")," to expose it in our schema."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-ts",metastring:'title="todo-item/todo-item.dto.ts"',title:'"todo-item/todo-item.dto.ts"'},"import { FilterableField, FilterableConnection, KeySet } from '@nestjs-query/query-graphql';\nimport { ObjectType, ID, GraphQLISODateTime, Field } from '@nestjs/graphql';\nimport { SubTaskDTO } from '../../sub-task/dto/sub-task.dto';\n\n@ObjectType('TodoItem')\n@KeySet(['id'])\n@FilterableConnection('subTasks', () => SubTaskDTO, { disableRemove: true })\n@FilterableConnection('completedSubTasks', () => SubTaskDTO, {\n  // disable remove and update because it is a virtual relation\n  disableRemove: true,\n  disableUpdate: true,\n})\nexport class TodoItemDTO {\n  @FilterableField(() => ID)\n  id!: number;\n\n  @FilterableField()\n  title!: string;\n\n  @FilterableField({ nullable: true })\n  description?: string;\n\n  @FilterableField()\n  completed!: boolean;\n\n  @FilterableField(() => GraphQLISODateTime)\n  created!: Date;\n\n  @FilterableField(() => GraphQLISODateTime)\n  updated!: Date;\n}\n\n")),Object(i.b)("p",null,"Next we need to export the ",Object(i.b)("inlineCode",{parentName:"p"},"SubTask")," query service from the ",Object(i.b)("inlineCode",{parentName:"p"},"SubTaskModule")," so we can resolve it in the\n",Object(i.b)("inlineCode",{parentName:"p"},"TodoItemService"),"."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-ts",metastring:"title='sub-task/sub-task.module.ts'",title:"'sub-task/sub-task.module.ts'"},"import { NestjsQueryGraphQLModule } from '@nestjs-query/query-graphql';\nimport { NestjsQueryTypeOrmModule } from '@nestjs-query/query-typeorm';\nimport { Module } from '@nestjs/common';\nimport { SubTaskDTO } from './dto/sub-task.dto';\nimport { SubTaskEntity } from './sub-task.entity';\n\n// define the persistence module so it can be exported\nconst nestjsQueryTypeOrmModule = NestjsQueryTypeOrmModule.forFeature([SubTaskEntity]);\n\n@Module({\n  imports: [\n    NestjsQueryGraphQLModule.forFeature({\n      // import it in the graphql module\n      imports: [nestjsQueryTypeOrmModule],\n      resolvers: [\n        {\n          DTOClass: SubTaskDTO,\n          EntityClass: SubTaskEntity,\n        },\n      ],\n    }),\n    // import it into the subTaskModule so it can be exported\n    nestjsQueryTypeOrmModule,\n  ],\n  // export the persistence module so it can be used by the TodoItemService\n  exports: [nestjsQueryTypeOrmModule],\n})\nexport class SubTaskModule {}\n")),Object(i.b)("p",null,"Now we can import the ",Object(i.b)("inlineCode",{parentName:"p"},"SubTaskModule")," into the ",Object(i.b)("inlineCode",{parentName:"p"},"TodoItemModule")," so the ",Object(i.b)("inlineCode",{parentName:"p"},"SubTask")," query service can be injected into\nthe ",Object(i.b)("inlineCode",{parentName:"p"},"TodoItemService"),"."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-ts",metastring:'title="todo-item/todo-item.module.ts"',title:'"todo-item/todo-item.module.ts"'},"import { NestjsQueryGraphQLModule } from '@nestjs-query/query-graphql';\nimport { NestjsQueryTypeOrmModule } from '@nestjs-query/query-typeorm';\nimport { Module } from '@nestjs/common';\nimport { TodoItemDTO } from './dto/todo-item.dto';\nimport { TodoItemAssembler } from './todo-item.assembler';\nimport { TodoItemEntity } from './todo-item.entity';\nimport { TodoItemResolver } from './todo-item.resolver';\nimport { TodoItemService } from './todo-item.service';\nimport { SubTaskModule } from '../sub-task/sub-task.module';\n\n@Module({\n  providers: [TodoItemResolver],\n  imports: [\n    NestjsQueryGraphQLModule.forFeature({\n      // import the persistence module for the TodoItemEntity and the SubTaskModule\n      imports: [NestjsQueryTypeOrmModule.forFeature([TodoItemEntity]), SubTaskModule],\n      services: [TodoItemService],\n      assemblers: [TodoItemAssembler],\n      resolvers: [\n        {\n          DTOClass: TodoItemDTO,\n          ServiceClass: TodoItemService,\n        },\n      ],\n    }),\n  ],\n})\nexport class TodoItemModule {}\n\n")),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"completedSubTasks")," relation is now available in your graphql schema.  "),Object(i.b)("h3",{id:"proxyqueryservice"},"ProxyQueryService"),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"ProxyQueryService")," is a query service that delegates to another query service. The ",Object(i.b)("inlineCode",{parentName:"p"},"ProxyQueryService")," can be used when you want to override certain methods of a query service without extending it. "),Object(i.b)("p",null,"This class is used internally by the ",Object(i.b)("a",{parentName:"p",href:"#relation-query-service"},"RelationQueryService")," to override the relation methods for a ",Object(i.b)("inlineCode",{parentName:"p"},"QueryService")," "),Object(i.b)("p",null,"Lets use the ",Object(i.b)("inlineCode",{parentName:"p"},"ProxyQueryService")," to create a generic query service that will time and log a message everytime a ",Object(i.b)("inlineCode",{parentName:"p"},"create"),", ",Object(i.b)("inlineCode",{parentName:"p"},"update"),", or ",Object(i.b)("inlineCode",{parentName:"p"},"delete")," method is called."),Object(i.b)("p",null,"To start lets define a ",Object(i.b)("inlineCode",{parentName:"p"},"MutationLoggerQueryService"),"."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-ts",metastring:'title="utilities/mutation-logger-query.service.ts"',title:'"utilities/mutation-logger-query.service.ts"'},"import { Logger, LoggerService } from '@nestjs/common';\nimport { DeepPartial } from '../common';\nimport { Filter, DeleteManyResponse, DeleteOneOptions, UpdateManyResponse, UpdateOneOptions } from '../interfaces';\nimport { ProxyQueryService } from './proxy-query.service';\nimport { QueryService } from './query.service';\n\nexport class MutationLoggerQueryService<DTO, C = DeepPartial<DTO>, U = DeepPartial<DTO>> extends ProxyQueryService<\n  DTO,\n  C,\n  U\n> {\n  private readonly logger: LoggerService;\n\n  constructor(label: string, queryService: QueryService<DTO, C, U>) {\n    // call super witht the QueryService we will delegate to\n    super(queryService);\n    // create our logger\n    this.logger = new Logger(label);\n  }\n\n  // Override all the create, update, and delete methods to add the timed logging functionality\n  createMany(items: C[]): Promise<DTO[]> {\n    return this.timedLog(`create many [itemCount=${items.length}]`, () => super.createMany(items));\n  }\n\n  createOne(item: C): Promise<DTO> {\n    return this.timedLog(`create one`, () => super.createOne(item));\n  }\n\n  deleteMany(filter: Filter<DTO>): Promise<DeleteManyResponse> {\n    return this.timedLog(`delete many`, () => super.deleteMany(filter));\n  }\n\n  deleteOne(id: number | string, opts?: DeleteOneOptions<DTO>): Promise<DTO> {\n    return this.timedLog(`delete one [id=${id}]`, () => super.deleteOne(id, opts));\n  }\n\n  updateMany(update: U, filter: Filter<DTO>): Promise<UpdateManyResponse> {\n    return this.timedLog('update many', () => super.updateMany(update, filter));\n  }\n\n  updateOne(id: string | number, update: U, opts?: UpdateOneOptions<DTO>): Promise<DTO> {\n    return this.timedLog(`update one [id=${id}]`, () => super.updateOne(id, update, opts));\n  }\n\n  private async timedLog<T>(message, fn: () => Promise<T>): Promise<T> {\n    const start = new Date();\n    const result = await fn();\n    const duration = start.getTime() - new Date().getTime();\n    this.logger.log(`${message} [duration=${duration}]`);\n    return result;\n  }\n}\n")),Object(i.b)("p",null,"We can now add timed logging to any query service."),Object(i.b)("p",null,"Lets add it to our ",Object(i.b)("inlineCode",{parentName:"p"},"TodoItemQueryService")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-ts",metastring:'title="todo-item/todo-item.service.ts"',title:'"todo-item/todo-item.service.ts"'},"import { InjectQueryService, QueryService } from '@nestjs-query/core';\nimport { MutationLoggerQueryService } from '../utilities/mutation-logger-query.service';\nimport { TodoItemEntity } from './todo-item.entity';\n\n@QueryService(TodoItemEntity)\nexport class TodoItemService extends MutationLoggerQueryService<TodoItemEntity> {\n  constructor(@InjectQueryService(TodoItemEntity) service: QueryService<TodoItemEntity>) {\n    // provide the logger name and the service\n    super(TodoItemService.name, service);\n  }\n}\n")),Object(i.b)("p",null,"Don't forget to use your custom query service in your module"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-ts",metastring:'title="todo-item/todo-item.module.ts"',title:'"todo-item/todo-item.module.ts"'},"import { NestjsQueryGraphQLModule } from '@nestjs-query/query-graphql';\nimport { NestjsQueryTypeOrmModule } from '@nestjs-query/query-typeorm';\nimport { Module } from '@nestjs/common';\nimport { TodoItemDTO } from './dto/todo-item.dto';\nimport { TodoItemEntity } from './todo-item.entity';\nimport { TodoItemService } from './todo-item.service';\n\n@Module({\n  imports: [\n    NestjsQueryGraphQLModule.forFeature({\n      imports: [NestjsQueryTypeOrmModule.forFeature([TodoItemEntity])],\n      services: [TodoItemService],\n      resolvers: [\n        {\n          DTOClass: TodoItemDTO,\n          ServiceClass: TodoItemService,\n        },\n      ],\n    }),\n  ],\n})\nexport class TodoItemModule {}\n\n")),Object(i.b)("h3",{id:"noopqueryservice"},"NoOpQueryService"),Object(i.b)("p",null,"The no-op query service is one that will throw a ",Object(i.b)("inlineCode",{parentName:"p"},"NotImplementedException")," for every method."),Object(i.b)("p",null,"This is commonly used during testing when you want to mock out a service.  "),Object(i.b)("p",null,"You can also use the ",Object(i.b)("inlineCode",{parentName:"p"},"NoOpQueryService")," as a base a new query service that only supports a subset of operations. "),Object(i.b)("p",null,"In this example we'll create a simple query service that stores elements in an array but does not support relations or aggregations."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-ts"},"import {\n  applyFilter,\n  applyQuery,\n  DeleteManyResponse,\n  DeleteOneOptions,\n  Filter,\n  FindByIdOptions,\n  GetByIdOptions,\n  NoOpQueryService,\n  Query,\n  QueryService,\n  UpdateManyResponse,\n  UpdateOneOptions,\n} from '@nestjs-query/core';\nimport { NotFoundException } from '@nestjs/common';\nimport { TodoItemEntity } from './todo-item.entity';\n\n@QueryService(TodoItemEntity)\nexport class TodoItemService extends NoOpQueryService<TodoItemEntity> {\n  private records: TodoItemEntity[];\n\n  constructor() {\n    super();\n    this.records = [];\n  }\n\n  createMany(items: TodoItemEntity[]): Promise<TodoItemEntity[]> {\n    this.records.push(...items);\n    return Promise.resolve(items);\n  }\n\n  createOne(item: TodoItemEntity): Promise<TodoItemEntity> {\n    this.records.push(item);\n    return Promise.resolve(item);\n  }\n\n  async updateMany(update: Partial<TodoItemEntity>, filter: Filter<TodoItemEntity>): Promise<UpdateManyResponse> {\n    const recordsToUpdate = await this.query({ filter });\n    recordsToUpdate.forEach((r) => Object.assign(r, update));\n    return { updatedCount: recordsToUpdate.length };\n  }\n\n  async updateOne(\n    id: string | number,\n    update: Partial<TodoItemEntity>,\n    opts?: UpdateOneOptions<TodoItemEntity>,\n  ): Promise<TodoItemEntity> {\n    const record = await this.getById(id, opts);\n    return Object.assign(record, update);\n  }\n\n  async deleteMany(filter: Filter<TodoItemEntity>): Promise<DeleteManyResponse> {\n    const recordIds = (await this.query({ filter })).map((r) => r.id);\n    this.records = this.records.filter((r) => !recordIds.includes(r.id));\n    return Promise.resolve({ deletedCount: recordIds.length });\n  }\n\n  async deleteOne(id: number | string, opts?: DeleteOneOptions<TodoItemEntity>): Promise<TodoItemEntity> {\n    const record = await this.getById(id, opts);\n    this.records = this.records.filter((r) => r.id !== record.id);\n    return Promise.resolve(record);\n  }\n\n  findById(id: string | number, opts?: FindByIdOptions<TodoItemEntity>): Promise<TodoItemEntity | undefined> {\n    const record = applyFilter(this.records, opts?.filter ?? {}).find((r) => r.id === id);\n    return Promise.resolve(record);\n  }\n\n  async getById(id: string | number, opts?: GetByIdOptions<TodoItemEntity>): Promise<TodoItemEntity> {\n    const record = await this.findById(id, opts);\n    if (!record) {\n      throw new NotFoundException(`Unable to find TodoItem with id ${id}`);\n    }\n    return record;\n  }\n\n  query(query: Query<TodoItemEntity>): Promise<TodoItemEntity[]> {\n    return Promise.resolve(applyQuery(this.records, query));\n  }\n\n  async count(filter: Filter<TodoItemEntity>): Promise<number> {\n    const found = await this.query({ filter });\n    return found.length;\n  }\n}\n\n")))}d.isMDXComponent=!0},218:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return m}));var r=n(0),i=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var d=i.a.createContext({}),c=function(e){var t=i.a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},b=function(e){var t=c(e.components);return i.a.createElement(d.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},p=i.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,a=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),b=c(n),p=r,m=b["".concat(a,".").concat(p)]||b[p]||u[p]||o;return n?i.a.createElement(m,l(l({ref:t},d),{},{components:n})):i.a.createElement(m,l({ref:t},d))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,a=new Array(o);a[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,a[1]=l;for(var d=2;d<o;d++)a[d]=n[d];return i.a.createElement.apply(null,a)}return i.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"}}]);